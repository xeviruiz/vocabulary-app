<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Learning App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        /* Custom scrollbar for modal */
        #modal-content::-webkit-scrollbar, #my-words-section div::-webkit-scrollbar {
            width: 8px;
        }
        #modal-content::-webkit-scrollbar-track, #my-words-section div::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        #modal-content::-webkit-scrollbar-thumb, #my-words-section div::-webkit-scrollbar-thumb {
            background-color: #334155; /* slate-700 */
            border-radius: 10px;
            border: 2px solid #1e293b; /* slate-800 */
        }
        #modal-content::-webkit-scrollbar-thumb:hover, #my-words-section div::-webkit-scrollbar-thumb:hover {
            background-color: #475569; /* slate-600 */
        }
        /* Table styles */
        #modal-content table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.875rem;
        }
        #modal-content th, #modal-content td {
            border: 1px solid #334155; /* slate-700 */
            padding: 8px 12px;
            text-align: left;
        }
        #modal-content th {
            background-color: #334155; /* slate-700 */
        }
        #modal-content tr:nth-child(even) {
            background-color: #162033;
        }
        /* Styles for sentence feedback */
        #feedback-container ul {
            list-style-type: disc;
            list-style-position: inside;
            margin-top: 0.5rem;
            padding-left: 0.5rem;
        }
        #feedback-container li {
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }
        #feedback-container strong {
            color: #fca5a5; /* red-300 */
            font-weight: 600;
        }
        #feedback-container p:not(:first-child) {
            margin-top: 0.75rem;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-md mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-slate-100">Bækur</h1>
            <p class="text-slate-400">Icelandic Vocabulary Practice</p>
        </header>

        <!-- Data Retrieval Button -->
        <div id="retrieve-container" class="text-center mb-4">
            <button id="retrieve-data-btn" class="bg-sky-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-sky-700 transition-colors w-full max-w-xs mx-auto">Retrieve All Words</button>
        </div>

        <!-- Main App Content (hidden by default) -->
        <div id="main-content" class="hidden">
            <!-- Navigation -->
            <nav class="flex justify-center mb-6 bg-slate-800 p-1 rounded-lg border border-slate-700">
                <button data-target="exercises-section" class="nav-btn flex-1 py-2 px-4 rounded-md text-sm font-semibold transition-colors duration-300 bg-sky-600 text-white">Exercises</button>
                <button data-target="input-section" class="nav-btn flex-1 py-2 px-4 rounded-md text-sm font-semibold transition-colors duration-300">Input</button>
                <button data-target="my-words-section" class="nav-btn flex-1 py-2 px-4 rounded-md text-sm font-semibold transition-colors duration-300">My Words</button>
            </nav>

            <!-- Exercises Section -->
            <section id="exercises-section" class="section active">
                <div class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700">
                    <p id="prompt-label" class="text-center text-slate-400 mb-2">What is the meaning of:</p>
                    <h2 id="prompt-word" class="text-2xl font-bold mb-4 text-center text-sky-400 leading-tight">...</h2>
                    <div id="exercise-content">
                        <textarea id="answer-input" placeholder="Your answer..." rows="2" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 placeholder:text-slate-400 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow duration-200 resize-none"></textarea>
                        <div id="feedback-container" class="text-left mt-4 text-sm min-h-[20px] bg-slate-700/50 p-3 rounded-lg border border-slate-700 hidden"></div>
                        <div class="flex gap-4 mt-4">
                            <button id="check-answer" class="w-full bg-sky-600 text-white py-3 px-4 rounded-lg hover:bg-sky-700 transition-colors duration-300 font-semibold shadow-md shadow-sky-600/20">Check</button>
                            <button id="give-up" class="w-full bg-slate-600 text-white py-3 px-4 rounded-lg hover:bg-slate-700 transition-colors duration-300 font-semibold">I give up</button>
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button id="next-word" class="text-sky-400 hover:text-sky-300 transition-colors text-sm">Next word &rarr;</button>
                    </div>
                </div>
            </section>

            <!-- Input Vocab Section -->
            <section id="input-section" class="section">
                <div class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700">
                    <h2 class="text-2xl font-semibold mb-4 text-center text-slate-100">Add New Vocabulary</h2>
                    <div class="space-y-4">
                        <input type="text" id="new-word-input" placeholder="Enter a word or phrase (e.g., 'bók')" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 placeholder:text-slate-400 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow duration-200">
                        <input type="text" id="user-translation-input" placeholder="Optional: your translation (e.g., 'book')" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 placeholder:text-slate-400 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow duration-200">
                        <button id="add-word" class="w-full bg-emerald-600 text-white py-3 px-4 rounded-lg hover:bg-emerald-700 transition-colors duration-300 font-semibold shadow-md shadow-emerald-600/20">Add</button>
                    </div>
                    <p id="input-feedback" class="text-center mt-4 text-sm"></p>
                </div>
            </section>

            <!-- My Words Section -->
            <section id="my-words-section" class="section">
                <div class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700">
                    <h2 class="text-2xl font-semibold mb-4 text-center text-slate-100">My Vocabulary List</h2>
                    <div id="word-list-container" class="space-y-3 max-h-80 overflow-y-auto pr-2">
                        <!-- Word list will be injected here -->
                    </div>
                </div>
            </section>
        </div>

         <!-- Word Info Modal -->
        <div id="word-info-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
            <div class="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col">
                <div id="modal-content" class="p-6 overflow-y-auto">
                    <!-- Content will be injected by JS -->
                </div>
                <div class="p-4 border-t border-slate-700">
                    <button id="close-modal" class="w-full bg-sky-600 text-white py-2 px-4 rounded-lg hover:bg-sky-700 transition-colors duration-300">Close</button>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
             <div class="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl w-full max-w-sm">
                <div class="p-6">
                    <h3 class="text-lg font-semibold text-slate-100" id="confirm-modal-title">Are you sure?</h3>
                    <p class="text-slate-400 mt-2" id="confirm-modal-text">This action cannot be undone.</p>
                </div>
                <div class="p-4 bg-slate-900/50 flex justify-end gap-3 rounded-b-xl">
                     <button id="confirm-cancel-btn" class="bg-slate-600 text-white py-2 px-4 rounded-lg hover:bg-slate-700 transition-colors">Cancel</button>
                     <button id="confirm-delete-btn" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">Delete</button>
                </div>
             </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, updateDoc, serverTimestamp, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyC__btBKiKWMrZGb1zHCEShLPUWycoB8gY",
          authDomain: "booktranslator-e00e3.firebaseapp.com",
          projectId: "booktranslator-e00e3",
          storageBucket: "booktranslator-e00e3.firebasestorage.app",
          messagingSenderId: "659040771936",
          appId: "1:659040771936:web:5dc47917b85a8f6f2a4805",
          measurementId: "G-YF7YP3E0CC"
        };

        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        let allWords = [];
        let currentExercise = null;
        
        // Define the path for the public collection
        const PUBLIC_WORDS_PATH = 'public/shared-words/words';

        // --- UI ELEMENTS ---
        const retrieveDataBtn = document.getElementById('retrieve-data-btn');
        const mainContent = document.getElementById('main-content');
        
        const navBtns = document.querySelectorAll('.nav-btn');
        const sections = document.querySelectorAll('.section');
        const myWordsSection = document.getElementById('my-words-section');
        const wordListContainer = document.getElementById('word-list-container');
        const addWordBtn = document.getElementById('add-word');
        const newWordInput = document.getElementById('new-word-input');
        const userTranslationInput = document.getElementById('user-translation-input');
        const inputFeedback = document.getElementById('input-feedback');
        const promptLabel = document.getElementById('prompt-label');
        const promptWord = document.getElementById('prompt-word');
        const answerInput = document.getElementById('answer-input');
        const checkAnswerBtn = document.getElementById('check-answer');
        const giveUpBtn = document.getElementById('give-up');
        const nextWordBtn = document.getElementById('next-word');
        const feedbackContainer = document.getElementById('feedback-container');
        const wordInfoModal = document.getElementById('word-info-modal');
        const modalContent = document.getElementById('modal-content');
        const closeModalBtn = document.getElementById('close-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        // --- APP LOGIC ---

        retrieveDataBtn.addEventListener('click', async () => {
            setButtonLoading(retrieveDataBtn, true, "Retrieving...");
            await loadAllWordsFromDB();
            loadNextExercise();
            mainContent.classList.remove('hidden');
            retrieveDataBtn.parentElement.classList.add('hidden');
        });

        // Navigation
        navBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.dataset.target;

                navBtns.forEach(b => b.classList.remove('bg-sky-600', 'text-white'));
                btn.classList.add('bg-sky-600', 'text-white');

                sections.forEach(sec => {
                    sec.classList.remove('active');
                    if (sec.id === targetId) {
                        sec.classList.add('active');
                    }
                });

                if (targetId === 'my-words-section') {
                    loadAndDisplayWords();
                }
            });
        });

        // --- VOCABULARY INPUT ---
        addWordBtn.addEventListener('click', async () => {
            const originalWord = newWordInput.value.trim().toLowerCase();
            const userTranslation = userTranslationInput.value.trim();
            if (!originalWord) {
                showInputFeedback("Please enter a word or phrase.", "text-red-400");
                return;
            }

            setButtonLoading(addWordBtn, true);

            try {
                let keyForDb;
                const isPhrase = originalWord.includes(' ');

                if (isPhrase) {
                    keyForDb = originalWord;
                } else {
                    keyForDb = await getBaseFormFromGemini(originalWord);
                }
                
                const wordRef = doc(db, PUBLIC_WORDS_PATH, keyForDb);
                const docSnap = await getDoc(wordRef);

                if (docSnap.exists()) {
                    showInputFeedback(`"${keyForDb}" is already in your list.`, "text-yellow-400");
                } else {
                    await setDoc(wordRef, {
                        word: keyForDb,
                        practicedCount: 0,
                        createdAt: serverTimestamp(),
                        userTranslation: userTranslation || "",
                        originalInput: originalWord
                    });
                    showInputFeedback(`Successfully added "${keyForDb}"!`, "text-green-400");
                    // Add the new word to our local cache to avoid re-fetching
                    allWords.push({ 
                        id: keyForDb, 
                        word: keyForDb, 
                        practicedCount: 0, 
                        userTranslation: userTranslation || "", 
                        originalInput: originalWord 
                    });
                    newWordInput.value = '';
                    userTranslationInput.value = '';
                    if (myWordsSection.classList.contains('active')) {
                        loadAndDisplayWords();
                    }
                }
            } catch (error) {
                console.error("Error adding word: ", error);
                showInputFeedback("Could not add item. See console for details.", "text-red-400");
            } finally {
                setButtonLoading(addWordBtn, false);
            }
        });
        
        async function loadAllWordsFromDB() {
            const tempWords = new Map();

            // 1. Fetch from the new public path
            const publicWordsCollection = collection(db, PUBLIC_WORDS_PATH);
            const publicWordsSnapshot = await getDocs(publicWordsCollection);
            publicWordsSnapshot.forEach(wordDoc => {
                tempWords.set(wordDoc.id, {
                    id: wordDoc.id,
                    isPublic: true, // Mark as public for deletion purposes
                    ...wordDoc.data()
                });
            });
            
            // 2. Fetch from the old user-based paths
            const usersCollection = collection(db, 'users');
            const userSnapshots = await getDocs(usersCollection);

            for (const userDoc of userSnapshots.docs) {
                const wordsCollection = collection(db, `users/${userDoc.id}/words`);
                const wordsSnapshot = await getDocs(wordsCollection);
                wordsSnapshot.forEach(wordDoc => {
                    // Only add if it's not already in the map from the public collection
                    if (!tempWords.has(wordDoc.id)) {
                        tempWords.set(wordDoc.id, {
                            id: wordDoc.id,
                            userId: userDoc.id, // Keep original owner for deletion
                            ...wordDoc.data()
                        });
                    }
                });
            }
            
            allWords = Array.from(tempWords.values());
        }


        // --- EXERCISE LOGIC ---
        async function loadNextExercise() {
            if (allWords.length === 0) {
                promptWord.textContent = 'No words loaded';
                document.getElementById('exercise-content').style.display = 'none';
                return;
            }
            
            document.getElementById('exercise-content').style.display = 'block';
            promptWord.textContent = 'Loading...';
            answerInput.value = '';
            feedbackContainer.innerHTML = '';
            feedbackContainer.classList.add('hidden');

            let words = [...allWords];
            words.sort((a, b) => a.practicedCount - b.practicedCount);
            
            const isSentenceExercise = Math.random() < 0.25;
            const singleWords = words.filter(w => !w.word.includes(' '));

            if (isSentenceExercise && singleWords.length > 0) {
                // Sentence Exercise Logic
                const oneThirdIndex = Math.ceil(singleWords.length / 3);
                const randomIndex = Math.floor(Math.random() * oneThirdIndex);
                const wordData = singleWords[randomIndex];

                promptLabel.textContent = 'Translate this sentence to Icelandic:';
                promptWord.classList.remove('text-4xl');
                promptWord.classList.add('text-2xl');
                try {
                    const englishWord = await getEnglishTranslationFromGemini(wordData.word);
                    const sentence = await getSentenceFromGemini(englishWord);
                    currentExercise = { type: 'sentence', data: wordData, sentence: sentence };
                    promptWord.textContent = `"${sentence}"`;
                } catch (e) {
                     // Fallback to word exercise
                    currentExercise = { type: 'word', data: wordData };
                    promptLabel.textContent = 'What is the meaning of:';
                    promptWord.classList.add('text-4xl');
                    promptWord.classList.remove('text-2xl');
                    promptWord.textContent = currentExercise.data.word;
                }
            } else {
                // Word/Phrase Exercise Logic
                const oneThirdIndex = Math.ceil(words.length / 3);
                const randomIndex = Math.floor(Math.random() * oneThirdIndex);
                const wordData = words[randomIndex];
                
                currentExercise = { type: 'word', data: wordData };
                promptLabel.textContent = 'What is the meaning of:';
                promptWord.classList.add('text-4xl');
                promptWord.classList.remove('text-2xl');
                promptWord.textContent = currentExercise.data.word;
            }
        }

        checkAnswerBtn.addEventListener('click', async () => {
            const userAnswer = answerInput.value.trim();
            if (!userAnswer || !currentExercise) return;

            setButtonLoading(checkAnswerBtn, true);
            feedbackContainer.innerHTML = `<p class="text-center text-slate-400">Checking...</p>`;
            feedbackContainer.classList.remove('hidden');

            try {
                if (currentExercise.type === 'word') {
                    const isCorrect = await checkAnswerWithGemini(currentExercise.data.word, userAnswer);
                    if (isCorrect) {
                        feedbackContainer.innerHTML = `<p class="text-center text-green-400 font-semibold">Correct!</p>`;
                        await updatePracticeCount(currentExercise.data, 1);
                        await showWordInfo(currentExercise.data);
                    } else {
                        feedbackContainer.innerHTML = `<p class="text-center text-red-400 font-semibold">Not quite. Try again!</p>`;
                    }
                } else { // Sentence exercise
                    const result = await checkSentenceWithGemini(currentExercise.sentence, userAnswer, currentExercise.data.word);
                    const [status, explanation] = result.split('---').map(s => s.trim());

                    if (status === 'CORRECT') {
                        feedbackContainer.innerHTML = `<p class="text-green-400 font-semibold">Correct! Great job!</p>`;
                        await updatePracticeCount(currentExercise.data, 1);
                        await showWordInfo(currentExercise.data);
                    } else {
                        feedbackContainer.innerHTML = `<p class="text-red-400 font-semibold mb-2">Not quite. Here's some feedback:</p><div class="text-slate-300">${explanation}</div>`;
                    }
                }
            } catch (error) {
                console.error('Error checking answer:', error);
                feedbackContainer.innerHTML = `<p class="text-center text-red-400">Error checking answer.</p>`;
            } finally {
                setButtonLoading(checkAnswerBtn, false);
            }
        });

        giveUpBtn.addEventListener('click', async () => {
             if (!currentExercise) return;
             setButtonLoading(giveUpBtn, true);
             feedbackContainer.innerHTML = `<p class="text-center text-slate-400">Revealing answer...</p>`;
             feedbackContainer.classList.remove('hidden');
             await updatePracticeCount(currentExercise.data, -1);
             await showWordInfo(currentExercise.data, true);
             setButtonLoading(giveUpBtn, false);
        });

        nextWordBtn.addEventListener('click', loadNextExercise);

        async function updatePracticeCount(wordObject, change) {
            const path = wordObject.isPublic ? PUBLIC_WORDS_PATH : `users/${wordObject.userId}/words`;
            const wordRef = doc(db, path, wordObject.id);
            const newCount = (wordObject.practicedCount || 0) + change;
            await updateDoc(wordRef, { practicedCount: newCount });
            // Update local cache
            const wordInCache = allWords.find(w => w.id === wordObject.id);
            if(wordInCache) wordInCache.practicedCount = newCount;
        }
        
        // --- MY WORDS LIST LOGIC ---
        function loadAndDisplayWords() {
            if (allWords.length === 0) {
                 wordListContainer.innerHTML = '<p class="text-slate-400 text-center">No words loaded yet. Click "Retrieve All Words" first.</p>';
                 return;
            }

            const sortedWords = [...allWords].sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
            
            wordListContainer.innerHTML = ''; 

            sortedWords.forEach(word => {
                const wordEl = document.createElement('div');
                wordEl.className = 'flex items-center justify-between bg-slate-700 p-3 rounded-lg';
                
                const wordTextEl = document.createElement('div');
                wordTextEl.className = 'cursor-pointer flex-grow mr-4';

                const originalInputText = (word.originalInput && word.originalInput !== word.word)
                    ? ` <span class="font-normal text-slate-400 text-sm">(from: ${word.originalInput})</span>`
                    : '';

                wordTextEl.innerHTML = `
                    <p class="font-semibold text-slate-100">${word.word}${originalInputText}</p>
                    <p class="text-sm text-slate-400">${word.userTranslation || 'No translation added'}</p>
                `;
                wordTextEl.addEventListener('click', () => showWordInfo(word));

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3V2h11v1h-11z"/></svg>`;
                deleteBtn.className = 'flex-shrink-0 bg-red-600/50 hover:bg-red-600/80 text-white p-2 rounded-full transition-colors';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openConfirmModal(word);
                });


                wordEl.appendChild(wordTextEl);
                wordEl.appendChild(deleteBtn);
                wordListContainer.appendChild(wordEl);
            });
        }
        
        function openConfirmModal(wordObject) {
            confirmModal.classList.remove('hidden');
            confirmModalTitle.textContent = `Delete "${wordObject.id}"?`;
            confirmModalText.textContent = `Are you sure you want to delete this item? This action cannot be undone.`;
            
            const deleteHandler = async () => {
                await deleteWord(wordObject);
                closeConfirmModal();
            };
            
            confirmDeleteBtn.onclick = deleteHandler;
        }

        function closeConfirmModal() {
            confirmModal.classList.add('hidden');
            confirmDeleteBtn.onclick = null; // Clean up listener
        }
        confirmCancelBtn.addEventListener('click', closeConfirmModal);


        async function deleteWord(wordObject) {
            try {
                const path = wordObject.isPublic ? PUBLIC_WORDS_PATH : `users/${wordObject.userId}/words`;
                await deleteDoc(doc(db, path, wordObject.id));
                // Remove from local cache
                allWords = allWords.filter(w => w.id !== wordObject.id);
                // Refresh list display
                loadAndDisplayWords();
            } catch (error) {
                console.error("Error deleting item: ", error);
            }
        }

        // --- GEMINI API INTEGRATION ---
        async function makeGeminiApiCall(prompt, retries = 3, delay = 1000) {
            const functionUrl = `/.netlify/functions/gemini`;
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(functionUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: prompt })
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Function call failed with status: ${response.status} - ${errorText}`);
                    }
                    const result = await response.json();
                    return result.text;
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i === retries - 1) throw error;
                    await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                }
            }
        }

        async function checkAnswerWithGemini(correctWord, userAnswer) {
             const prompt = `The original word or phrase is "${correctWord}". The user's answer for its translation is "${userAnswer}". Is the user's answer correct? Consider minor typos or slight variations in meaning as correct. Respond with only "CORRECT" or "INCORRECT".`;
             const response = await makeGeminiApiCall(prompt);
             return response.trim().toUpperCase() === 'CORRECT';
        }
        
        async function checkSentenceWithGemini(englishSentence, userAnswer, word) {
            const prompt = `The original English sentence is: "${englishSentence}". The user's Icelandic translation is: "${userAnswer}". The key vocabulary word is "${word}".
First, on a single line, respond with only "CORRECT" or "INCORRECT".
On a new line, add "---".
After that, provide a detailed but friendly analysis of any mistakes in the user's translation using simple HTML.
- Use a <ul> for a list of mistakes if there are multiple.
- Use <li> for each individual mistake.
- Use <strong> to highlight key terms or incorrect parts of the user's answer.
- Provide a corrected version of the sentence, perhaps wrapped in a <p> tag with a label like "Corrected sentence:".
- Explain each mistake clearly, covering grammar, word choice, and word order.
If the translation is perfect, simply write "<p>Excellent work, the translation is perfect.</p>".
Do not include any other text, markdown, or code blocks outside the HTML structure.`;
            return await makeGeminiApiCall(prompt);
        }

        async function getEnglishTranslationFromGemini(word) {
            const prompt = `What is a common, single-word English translation for the Icelandic word "${word}"? Respond with ONLY the English word, in lowercase.`;
            const translation = await makeGeminiApiCall(prompt);
            return translation.trim();
        }

        async function getSentenceFromGemini(englishWord) {
            const prompt = `Create an English sentence for an A2-level language learner that prominently features the word "${englishWord}". The sentence should be interesting and provide good learning context, but use vocabulary and grammar appropriate for the A2 CEFR level. Avoid overly simple structures. Respond with ONLY the sentence.`;
            return await makeGeminiApiCall(prompt);
        }

        async function getBaseFormFromGemini(word) {
            const prompt = `What is the base form of the Icelandic word "${word}"? For a noun, this is the nominative singular. For a verb, this is the infinitive. For an adjective, this is the nominative singular masculine strong form. Respond with ONLY the base form and nothing else.`;
            const baseForm = await makeGeminiApiCall(prompt);
            return baseForm.trim().toLowerCase();
        }

        async function getWordInfoFromGemini(word) {
             const prompt = `Provide detailed information for the Icelandic word or phrase "${word}". Structure your response in four parts separated by "---".
1. A single line of comma-separated English translations.
---
2. A single line of comma-separated Icelandic synonyms or related phrases. If none, write "None".
---
3. If applicable, provide a full declension or conjugation table in a simple HTML table format with <th> headers. For phrases, this is not applicable, so write "N/A".
---
4. Three example sentences using the word or phrase. Each on a new line. Format: "Original Icelandic sentence. (English translation.)" Do NOT include numbers like "1.".`;
             const response = await makeGeminiApiCall(prompt);
             return response;
        }

        async function showWordInfo(wordObject, isGiveUp = false) {
             const word = wordObject.word;
             const userTranslation = wordObject.userTranslation;
             const originalInput = wordObject.originalInput;

             modalContent.innerHTML = `<div class="text-center"><div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent align[-0.125em] text-sky-400 motion-reduce:animate-[spin_1.5s_linear_infinite]" role="status"></div><p class="mt-2 text-slate-400">Fetching word details...</p></div>`;
             wordInfoModal.classList.remove('hidden');

             try {
                const info = await getWordInfoFromGemini(word);
                const [translations, synonyms, table, sentences] = info.split('---').map(s => s.trim());

                let userTranslationHtml = userTranslation ? `
                    <div class="mb-4 p-3 bg-sky-500/10 text-sky-300 border border-sky-500/20 rounded-lg">
                        <h3 class="font-semibold text-lg text-sky-400">Your Translation:</h3>
                        <p class="text-slate-200 text-base">${userTranslation}</p>
                    </div>` : '';

                const originalInputHtml = (originalInput && originalInput !== word) ? `
                    <div class="mb-4 p-3 bg-slate-700/50 border border-slate-600/50 rounded-lg">
                        <h3 class="font-semibold text-base text-slate-400">Your Original Input:</h3>
                        <p class="text-slate-300 text-base">${originalInput}</p>
                    </div>` : '';

                const sentencesHtml = sentences.split('\n').filter(s => s).map(s => `
                    <blockquote class="border-l-4 border-slate-600 pl-4 py-2 my-2">
                        <p class="text-slate-300">${s}</p>
                    </blockquote>
                `).join('');

                modalContent.innerHTML = `
                    <h2 class="text-3xl font-bold mb-4 text-center capitalize text-slate-100">${word}</h2>
                    ${isGiveUp ? `<p class="text-center mb-4 p-2 bg-yellow-500/10 text-yellow-300 border border-yellow-500/20 rounded-lg">Here's the information. Practice count has been reduced.</p>` : ''}
                    ${userTranslationHtml}
                    ${originalInputHtml}
                    <div class="space-y-4">
                        <div>
                            <h3 class="font-semibold text-lg text-sky-400">AI Translations:</h3>
                            <p class="text-slate-300">${translations || 'N/A'}</p>
                        </div>
                        <div>
                            <h3 class="font-semibold text-lg text-sky-400">Synonyms:</h3>
                            <p class="text-slate-300">${synonyms || 'N/A'}</p>
                        </div>
                        <div>
                            <h3 class="font-semibold text-lg text-sky-400">Grammar:</h3>
                            <div class="prose prose-invert max-w-none text-slate-300 overflow-x-auto">${table || 'N/A'}</div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-lg text-sky-400">Examples:</h3>
                            ${sentencesHtml || '<p class="text-slate-300">N/A</p>'}
                        </div>
                    </div>
                `;
             } catch (error) {
                 console.error("Error fetching word info:", error);
                 modalContent.innerHTML = `<p class="text-center text-red-400">Could not load word information.</p>`;
             }
        }
        
        closeModalBtn.addEventListener('click', () => {
            wordInfoModal.classList.add('hidden');
        });

        // --- UTILITY FUNCTIONS ---
        function setButtonLoading(button, isLoading, loadingText = "Loading...") {
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = `<span class="inline-flex items-center">${loadingText}</span>`;
            } else {
                button.disabled = false;
                 if(button.id === 'add-word') button.textContent = 'Add';
                 else if (button.id === 'check-answer') button.textContent = 'Check';
                 else if (button.id === 'give-up') button.textContent = 'I give up';
                 else if (button.id === 'retrieve-data-btn') button.textContent = 'Retrieve All Words';
            }
        }

        function showInputFeedback(message, className) {
            inputFeedback.textContent = message;
            inputFeedback.className = `text-center mt-4 text-sm ${className}`;
            setTimeout(() => {
                inputFeedback.textContent = '';
            }, 3000);
        }

    </script>
</body>
</html>

